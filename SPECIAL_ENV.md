# 特殊环境与边界情况说明（SPECIAL_ENV.md）

## 运行时行为

### 工作目录自动切换

程序启动时会自动将工作目录切换到可执行文件所在目录（`main.go` 第 17-23 行）。这确保了以下相对路径始终正确：

- `config.yaml` — 配置文件
- `data.db` — SQLite 数据库
- `web/` — 前端静态资源

> 因此无论从哪个目录启动程序，都不会出现"找不到配置文件"的问题。

### SQLite 数据库

- 使用 WAL 模式（`journal_mode=WAL`），支持并发读取
- 设置了 `busy_timeout=5000`（5秒），避免并发写入时直接报错
- 表结构在程序启动时自动创建（`store.go` 的 `initTables`）
- 纯 Go 实现（`modernc.org/sqlite`），无需 CGO 或原生 SQLite 库

### SSE 流式传输

AI 对话使用 Server-Sent Events（SSE）实时推送。需要注意：

- 反向代理必须**关闭响应缓冲**（Nginx: `proxy_buffering off`；Caddy 默认支持）
- 设置了 `X-Accel-Buffering: no` 响应头以兼容 Nginx
- CDN 加速可能会缓冲 SSE 响应，建议 API 路径不走 CDN

## 口令检测机制

### 三层容错匹配

口令检测按以下优先级执行（`password.go`）：

| 层级 | 策略 | 场景 |
|------|------|------|
| 1 | 精确匹配 | AI 原样输出口令 |
| 2 | 去标点匹配 | AI 在口令中插入了标点变体（如"、"→","） |
| 3 | 关键词匹配 | AI 拆散口令或加入额外文字 |

**主口令始终优先于安慰奖检测**，杜绝误判。

### 关键词配置

关键词硬编码在 `password.go` 的 `NewPasswordChecker` 中：

- 主口令关键词：`["小喵科技", "身体安康", "万事如意"]`
- 安慰奖关键词：`["好运连连"]`

> ⚠️ 如果修改了 `config.yaml` 中的口令文本，需要同步修改 `password.go` 中的关键词列表。

## 福利机制状态机

用户的福利状态（`user_bonus_status` 表）流转如下：

```
"" (初始)
  → "offered"            （总轮次≥55，弹出选择）
  → "claimed_consolation" （选择领取安慰奖口令，流程终止）
  → "continued"           （选择继续挑战）
  → "claimed_grand"       （总轮次≥80，自动发放主口令，流程终止）
```

一旦进入 `claimed_*` 状态，用户将**无法再创建新对话**。

## 已知限制

1. **无密码加密**：用户登录不需要密码，仅凭联系方式 + 昵称即可参与
2. **会话 Token 简单生成**：格式为 `{时间戳}-{用户ID}`，非加密安全
3. **无 HTTPS 内置支持**：需通过反向代理（Caddy/Nginx）提供 TLS
4. **无 WebSocket**：使用 SSE 单向推送，适合当前场景但不支持双向通信
5. **图片存储本地**：上传的图片直接存在 `web/Pic/` 目录，未接入对象存储
