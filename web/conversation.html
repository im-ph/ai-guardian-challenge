<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¹è¯è¯¦æƒ… - AIå®ˆæŠ¤è€…æŒ‘æˆ˜</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="chat-container">
        <header class="chat-header">
            <div class="chat-title">
                <h2>ğŸ›¡ï¸ å¯¹è¯è¯¦æƒ…</h2>
                <div id="turnCounter" class="turn-counter"></div>
            </div>
            <div style="display:flex;gap:8px;">
                <button onclick="window.close()" class="back-btn">â† å…³é—­</button>
                <button onclick="window.location.href='/'" class="home-btn">ğŸ  é¦–é¡µ</button>
            </div>
        </header>
        <div id="chatMessages" class="chat-messages">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const conversationId = urlParams.get('id');

        async function loadConversation() {
            if (!conversationId) {
                document.getElementById('chatMessages').innerHTML = '<div class="no-data">æœªæŒ‡å®šå¯¹è¯ID</div>';
                return;
            }

            try {
                const response = await fetch(`/api/conversation/${conversationId}`);
                if (!response.ok) throw new Error('å¯¹è¯ä¸å­˜åœ¨');

                const conversation = await response.json();
                const messagesDiv = document.getElementById('chatMessages');
                messagesDiv.innerHTML = '';

                conversation.messages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.role}`;
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'message-content';

                    const imgMatch = msg.content.match(/\[å›¾ç‰‡:(\/Pic\/[^\]]+)\]/);
                    if (imgMatch) {
                        const imgUrl = imgMatch[1];
                        const textOnly = msg.content.replace(/\[å›¾ç‰‡:\/Pic\/[^\]]+\]\n?/, '').trim();
                        const img = document.createElement('img');
                        img.src = imgUrl;
                        img.className = 'message-image';
                        img.alt = 'ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡';
                        img.onclick = () => window.open(imgUrl, '_blank');
                        contentDiv.appendChild(img);
                        if (textOnly) {
                            const textNode = document.createTextNode(textOnly);
                            contentDiv.appendChild(textNode);
                        }
                    } else {
                        contentDiv.textContent = msg.content;
                    }

                    messageDiv.appendChild(contentDiv);
                    messagesDiv.appendChild(messageDiv);
                });

                document.getElementById('turnCounter').textContent =
                    `è½®æ¬¡: ${conversation.turnCount}/${conversation.maxTurns}`;

                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            } catch (error) {
                console.error('åŠ è½½å¯¹è¯å¤±è´¥:', error);
                document.getElementById('chatMessages').innerHTML =
                    '<div class="no-data">å¯¹è¯ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤</div>';
            }
        }

        loadConversation();
    </script>
</body>

</html>
